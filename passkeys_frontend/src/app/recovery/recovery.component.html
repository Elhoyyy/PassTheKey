<body>
 <div class="wrapper">
  <form class="login">
    <p class="title">
      <i class="bi bi-shield-lock"></i>
      {{ 
        stage === 'initial' ? 'Recuperación de Cuenta' : 
        stage === 'otp-verification' ? 'Verificación de Código' :
        stage === 'reset-options' ? 'Opciones de Recuperación' :
        'Restablecimiento de Contraseña'
      }}
    </p>

    <!-- Pantalla inicial -->
    <div *ngIf="stage === 'initial'">
      <div class="input-group">
        <i class="bi bi-envelope"></i>
        <input 
          type="email" 
          [(ngModel)]="username" 
          name="username" 
          placeholder="Email" 
          class="email-input"/>
      </div>

      <div class="buttons-container">
        <button 
          class="btn-auth" 
          (click)="requestRecovery()"
          [disabled]="isProcessing">
          <i *ngIf="!isProcessing" class="bi bi-send"></i>
          <span *ngIf="isProcessing" class="spinner-border spinner-border-sm"></span>
          <span>{{ isProcessing ? 'Enviando...' : 'Enviar código de recuperación' }}</span>
        </button>
      </div>

      <div class="links-container">
        <a (click)="goToLogin()">Volver al inicio de sesión</a>
      </div>
    </div>

    <!-- Pantalla de verificación OTP -->
    <div *ngIf="stage === 'otp-verification'">
      <div class="input-group">
        <i class="bi bi-shield-lock"></i>
        <input 
          type="text" 
          [(ngModel)]="otpCode" 
          name="otpCode" 
          placeholder="Código de verificación" 
          maxlength="6"
          autocomplete="one-time-code" />
      </div>

      <div class="otp-description">
        <p>Introduce el código de verificación de 6 dígitos.</p>
        <p>Este código cambia cada 30 segundos. <span *ngIf="expirySeconds">Siguiente código en: {{ expirySeconds }}s</span></p>
        
        <!-- Demo token always displayed for convenience during development -->
        <div class="demo-token-container">
          <p *ngIf="demoOtpCode"><small>Código actual: <span class="demo-token">{{demoOtpCode}}</span></small></p>
        </div>
      </div>

      <div class="dialog-footer">
        <button 
        class="btn btn-primary" 
          (click)="verifyOtp()"
          [disabled]="isProcessing">
          <i *ngIf="!isProcessing" class="bi bi-check-circle"></i>
          <span *ngIf="isProcessing" class="spinner-border spinner-border-sm"></span>
          <span>{{ isProcessing ? 'Verificando...' : 'Verificar' }}</span>
        </button>
        
        <button 
        class="btn btn-secondary" 
        (click)="cancelAndGoBack()"
          [disabled]="isProcessing">
          <i class="bi bi-x-circle"></i>
          <span>Cancelar</span>
        </button>
      </div>
    </div>
    <!-- Pantalla de opciones de recuperación -->
    <div *ngIf="stage === 'reset-options'">
      <div class="recovery-options">
        <p>Elige una opción para recuperar tu cuenta:</p>

        <!-- Opción de passkey destacada -->
        <button 
          class="btn-option btn-option-primary"
          (click)="passkeyRecovery()">
          <i class="bi bi-key"></i>
          <span>Crear nueva passkey</span>
          <small class="option-description">Opción recomendada - más segura y conveniente</small>
        </button>

        <div class="option-separator">
          <span>o</span>
        </div>

        <button 
          class="btn-option btn-option-secondary" 
          (click)="choosePasswordReset()">
          <i class="bi bi-lock"></i>
          <span>Restablecer contraseña</span>
        </button>
        
      </div>

      <div class="buttons-container">
        <button 
          class="btn-cancel" 
          (click)="cancelAndGoBack()">
          <i class="bi bi-arrow-left-circle"></i>
          <span>Volver</span>
        </button>
      </div>
    </div>

    <!-- Pantalla de restablecimiento de contraseña -->
    <div *ngIf="stage === 'password-reset'">
      <div class="input-group">
        <i class="bi bi-lock"></i>
        <input 
          type="password" 
          [(ngModel)]="newPassword" 
          name="newPassword" 
          placeholder="Nueva contraseña" 
          (input)="evaluatePasswordStrength()"/>
      </div>

          
      
      <div class="input-group">
        <i class="bi bi-lock-fill"></i>
        <input 
          type="password" 
          [(ngModel)]="confirmPassword" 
          name="confirmPassword" 
          placeholder="Confirmar contraseña" />
      </div>

      <div class="password-requirements">
        <p>La contraseña debe contener:</p>
        <ul>
          <li class="requirement" [ngClass]="{'met': passwordRequirements.length}">
            <i class="bi" [ngClass]="passwordRequirements.length ? 'bi-check-circle' : 'bi-x-circle'"></i>
            Mínimo 8 caracteres
          </li>
          <li class="requirement" [ngClass]="{'met': passwordRequirements.uppercase}">
            <i class="bi" [ngClass]="passwordRequirements.uppercase ? 'bi-check-circle' : 'bi-x-circle'"></i>
            Letra mayúscula
          </li>
          <li class="requirement" [ngClass]="{'met': passwordRequirements.number}">
            <i class="bi" [ngClass]="passwordRequirements.number ? 'bi-check-circle' : 'bi-x-circle'"></i>
            Número
          </li>
          <li class="requirement" [ngClass]="{'met': passwordRequirements.special}">
            <i class="bi" [ngClass]="passwordRequirements.special ? 'bi-check-circle' : 'bi-x-circle'"></i>
            Caracter Especial
          </li>
        </ul>
      </div>
      

      <div class="buttons-container">
        <button 
          class="btn-auth" 
          (click)="resetPassword()"
          [disabled]="isProcessing">
          <i *ngIf="!isProcessing" class="bi bi-check-circle"></i>
          <span *ngIf="isProcessing" class="spinner-border spinner-border-sm"></span>
          <span>{{ isProcessing ? 'Restableciendo...' : 'Restablecer contraseña' }}</span>
        </button>
        
        <button 
          class="btn-cancel" 
          (click)="cancelAndGoBack()"
          [disabled]="isProcessing">
          <i class="bi bi-x-circle"></i>
          <span>Cancelar</span>
        </button>
      </div>
    </div>

    <!-- Add passkey naming dialog for recovery -->
    <div *ngIf="showPasskeyNameDialog" class="passkey-name-dialog">
      <div class="dialog-content">
        <div class="dialog-header">
          <h5><i class="bi bi-shield-lock"></i>Nombra tu Llave de Acceso</h5>
        </div>
        <div class="dialog-body">
          <p>La llave de acceso te ayuda a iniciar sesión de forma rápida y segura sin contraseñas.</p>
          <div class="input-group">
            <span class="input-group-text"></span>
            <input type="text" class="form-control" [(ngModel)]="passkeyName" placeholder="Enter a name for this passkey">
          </div>

        </div>
        <div class="dialog-footer">
          <button class="btn btn-secondary" (click)="cancelPasskeyName()">
            <i class="bi bi-x-circle"></i>Cancelar
          </button>
          <button class="btn btn-primary" (click)="confirmPasskeyName()" [disabled]="!passkeyName.trim()">
            <i class="bi bi-check-circle"></i>Continuar
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="errorMessage" class="error-message">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ errorMessage }}
    </div>

    <div *ngIf="successMessage" class="success-message">
        <i class="bi bi-check-circle me-2"></i>{{ successMessage }}
    </div>
  </form>
 </div>
</body>