<div class="wrapper">
  <form class="login">
    <p class="title">
      <i class="bi bi-shield-lock"></i>
      {{ 
        stage === 'initial' ? 'Recuperación de Cuenta' : 
        stage === 'otp-verification' ? 'Verificación de código' :
        stage === 'reset-options' ? 'Opciones de Recuperación' :
        stage === 'setup-totp' ? 'Configurar Verificación en Dos Pasos' :
        'Restablecimiento de Contraseña'
      }}
    </p>

    <!-- Pantalla inicial -->
    <div *ngIf="stage === 'initial'">
      <div class="input-group">
        <i class="bi bi-envelope"></i>
        <input 
          type="email" 
          [(ngModel)]="username" 
          name="username" 
          placeholder="Email" 
          class="email-input"/>
      </div>

      <div class="buttons-container">
        <button 
          class="btn-auth" 
          (click)="requestRecovery()"
          [disabled]="isProcessing">
          <i *ngIf="!isProcessing" class="bi bi-send"></i>
          <span *ngIf="isProcessing" class="spinner-border spinner-border-sm"></span>
          <span>{{ isProcessing ? 'Enviando...' : 'Enviar correo de recuperación' }}</span>
        </button>
      </div>

      <div class="links-container">
        <a (click)="goToLogin()">Volver al inicio de sesión</a>
      </div>
    </div>

    <!-- Nueva pantalla de verificación OTP - MODIFICADO -->
    <div *ngIf="stage === 'otp-verification'">
      
      <div class="info-message">
        <i class="bi bi-info-circle"></i>
        <p *ngIf="hasPassword && hasPasskey">
          Tu cuenta tiene contraseña y llaves de acceso.
          Puedes verificar tu identidad con el código de verificación o usar un código de recuperación.
        </p>
        <p *ngIf="hasPassword && !hasPasskey">
          Tu cuenta solo tiene contraseña con verificación en dos pasos.
          Debes verificar tu identidad con el código de verificación o con el código de recuperación.
        </p>
        <p *ngIf="!hasPassword && hasPasskey">
          Tu cuenta solo tiene llaves de acceso.
          Debes verificar tu identidad usando uno de los códigos de recuperación guardados.
        </p>
      </div>
      
      <div class="input-group" *ngIf="hasPassword">
        <i class="bi bi-shield-lock"></i>
        <input 
          type="text" 
          [(ngModel)]="otpCode" 
          name="otpCode" 
          placeholder="Código de verificación" 
          maxlength="6"
          autocomplete="one-time-code" />
      </div>

      <div class="otp-description" *ngIf="hasPassword">
        <p>Introduce el código de verificación de 6 dígitos.</p>
        <p><span *ngIf="expirySeconds">Siguiente código en: {{ expirySeconds }}s</span></p>
      </div>

      <div class="dialog-footer" *ngIf="hasPassword"> 
        <button 
          class="btn btn-secondary" 
          (click)="cancelOtpVerification()"
          [disabled]="isVerifyingOtp">
          <i class="bi bi-x-circle"></i>
          <span>Cancelar</span>
        </button>
        <button 
          class="btn btn-primary" 
          (click)="verifyOtpCode()"
          [disabled]="isVerifyingOtp">
          <i *ngIf="!isVerifyingOtp" class="bi bi-check-circle"></i>
          <span *ngIf="isVerifyingOtp" class="spinner-border spinner-border-sm"></span>
          <span>{{ isVerifyingOtp ? 'Verificando...' : 'Verificar' }}</span>
        </button>
      </div>

  

      <!-- Recovery code option - Always show as fallback -->
      <div class="alternative-auth-container">
        <div class="option-separator">
          <span>o</span>
        </div>
        <button 
          class="btn-recovery-code" 
          (click)="showRecoveryCodeInput = !showRecoveryCodeInput"
          [disabled]="isVerifyingRecoveryCode">
          <i class="bi bi-shield-exclamation"></i>
          <span>Usar código de recuperación</span>
        </button>
        
        <!-- Recovery code input - conditional display -->
        <div *ngIf="showRecoveryCodeInput" class="recovery-code-section">
          <div class="input-group">
            <i class="bi bi-shield-exclamation"></i>
            <input 
              type="text" 
              [(ngModel)]="recoveryCode" 
              name="recoveryCode" 
              placeholder="Código de recuperación (XXXX-XXXX)" 
              maxlength="9"
              class="recovery-code-input" />
          </div>
          
          <div class="recovery-info">
            <p><i class="bi bi-info-circle"></i> Ingresa uno de los códigos de recuperación que guardaste al registrarte.</p>
          </div>
          
          <button 
            class="btn-verify-recovery" 
            (click)="verifyRecoveryCode()"
            [disabled]="isVerifyingRecoveryCode || !recoveryCode.trim()">
            <i *ngIf="!isVerifyingRecoveryCode" class="bi bi-check-circle"></i>
            <span *ngIf="isVerifyingRecoveryCode" class="spinner-border spinner-border-sm"></span>
            <span>{{ isVerifyingRecoveryCode ? 'Verificando...' : 'Verificar código' }}</span>
          </button>
        </div>
      </div>

    </div>

    <!-- Pantalla de opciones de recuperación -->
    <div *ngIf="stage === 'reset-options'">
      <div class="recovery-options">
        <p>Elige una opción para recuperar tu cuenta:</p>

        <!-- Opción de passkey destacada -->
        <button 
          class="btn-option btn-option-primary"
          (click)="passkeyRecovery()">
          <i class="bi bi-key"></i>
          <span>Crear nueva passkey</span>
          <small class="option-description">Opción recomendada - más segura y conveniente</small>
        </button>

        <div class="option-separator">
          <span>o</span>
        </div>

        <button 
          class="btn-option btn-option-secondary" 
          (click)="choosePasswordReset()">
          <i class="bi bi-lock"></i>
          <span>Restablecer contraseña</span>
        </button>
        
      </div>

      <div class="buttons-container">
        <button 
          class="btn-cancel" 
          (click)="cancelAndGoBack()">
          <i class="bi bi-arrow-left-circle"></i>
          <span>Volver</span>
        </button>
      </div>
    </div>
    <!-- Pantalla de restablecimiento de contraseña -->
    <div *ngIf="stage === 'password-reset'">
      <div class="input-group">
        <i class="bi bi-lock"></i>
        <input 
          id="newPassword"
          type="password" 
          [(ngModel)]="newPassword" 
          name="newPassword" 
          placeholder="Nueva contraseña" 
          (input)="evaluatePasswordStrength()"/>
          <span class="password-tugle" (click)="togglePasswordVisibility('newPassword')">
            <i class="bi bi-eye-slash"></i>
          </span>
      </div>

          
      
      <div class="input-group">
        <i class="bi bi-lock-fill"></i>
        <input 
          id="confirmPassword"
          type="password" 
          [(ngModel)]="confirmPassword" 
          name="confirmPassword" 
          placeholder="Confirmar contraseña" />
          <span class="password-tugle" (click)="togglePasswordVisibility('confirmPassword')">
          <i class="bi bi-eye-slash"></i>
          </span>
      </div>

      <div class="password-requirements">
        <p>La contraseña debe contener:</p>
        <ul>
          <li class="requirement" [ngClass]="{'met': passwordRequirements.length}">
            <i class="bi" [ngClass]="passwordRequirements.length ? 'bi-check-circle' : 'bi-x-circle'"></i>
            Mínimo 8 caracteres
          </li>
          <li class="requirement" [ngClass]="{'met': passwordRequirements.uppercase}">
            <i class="bi" [ngClass]="passwordRequirements.uppercase ? 'bi-check-circle' : 'bi-x-circle'"></i>
            Letra mayúscula
          </li>
          <li class="requirement" [ngClass]="{'met': passwordRequirements.number}">
            <i class="bi" [ngClass]="passwordRequirements.number ? 'bi-check-circle' : 'bi-x-circle'"></i>
            Número
          </li>
          <li class="requirement" [ngClass]="{'met': passwordRequirements.special}">
            <i class="bi" [ngClass]="passwordRequirements.special ? 'bi-check-circle' : 'bi-x-circle'"></i>
            Caracter Especial
          </li>
        </ul>
      </div>
      

      <div class="buttons-container">
        <button 
          class="btn-auth" 
          (click)="resetPassword()"
          [disabled]="isProcessing">
          <i *ngIf="!isProcessing" class="bi bi-check-circle"></i>
          <span *ngIf="isProcessing" class="spinner-border spinner-border-sm"></span>
          <span>{{ isProcessing ? 'Restableciendo...' : 'Restablecer contraseña' }}</span>
        </button>
        
        <button 
          class="btn-cancel" 
          (click)="cancelAndGoBack()"
          [disabled]="isProcessing">
          <i class="bi bi-x-circle"></i>
          <span>Cancelar</span>
        </button>
      </div>
    </div>

    <!-- Add passkey naming dialog for recovery -->
    <div *ngIf="showPasskeyNameDialog" class="passkey-name-dialog">
      <div class="dialog-content">
        <div class="dialog-header">
          <h5><i class="bi bi-shield-lock"></i>Nombra tu Llave de Acceso</h5>
        </div>
        <div class="dialog-body">
          <p>La llave de acceso te ayuda a iniciar sesión de forma rápida y segura sin contraseñas.</p>
          <div class="input-group">
            <span class="input-group-text"></span>
            <input type="text" class="form-control" [(ngModel)]="passkeyName" placeholder="Enter a name for this passkey">
          </div>

        </div>
        <div class="dialog-footer">
          <button class="btn btn-secondary" (click)="cancelPasskeyName()">
            <i class="bi bi-x-circle"></i>Cancelar
          </button>
          <button class="btn btn-primary" (click)="confirmPasskeyName()" [disabled]="!passkeyName.trim()">
            <i class="bi bi-check-circle"></i>Continuar
          </button>
        </div>
      </div>
    </div>

    <!-- Nueva pantalla para configurar TOTP después de restablecer contraseña -->
    <div *ngIf="stage === 'setup-totp'">
      <div class="info-message">
        <i class="bi bi-info-circle"></i>
        <p>Para completar el restablecimiento de tu contraseña, es necesario configurar la verificación en dos pasos.</p>
      </div>

      <div class="otp-description">
        <p>Escanea este código QR con tu aplicación de autenticación o ingresa el código manualmente.</p>
        <p><span *ngIf="expirySeconds">Siguiente código en: {{ expirySeconds }}s</span></p>
        
        <!-- QR code section -->
        <div class="qr-setup">
          <h4>Configurar Autenticador</h4>
          <img *ngIf="qrCodeUrl" [src]="qrCodeUrl" alt="QR Code" class="qr-code">
          
          <div class="manual-setup">
            <p>O ingresa manualmente este código:</p>
            <div class="secret-code">
              {{ otpSecret }}
              <button class="copy-button" (click)="copyToClipboard(otpSecret)" title="Copiar al portapapeles">
                <i class="bi" [ngClass]="copied ? 'bi-clipboard-check' : 'bi-clipboard'"></i>
              </button>
            </div>
          </div>
          
          <div class="setup-warning">
            <p class="warning"><i class="bi bi-exclamation-triangle"></i> IMPORTANTE: Esta información solo se mostrará una vez.</p>
          </div>
        </div>
      </div>
      
      <div class="input-group">
        <i class="bi bi-shield-lock"></i>
        <input 
          type="text" 
          [(ngModel)]="otpCode" 
          name="otpCode" 
          placeholder="Código de verificación" 
          maxlength="6"
          autocomplete="one-time-code" />
      </div>

      <div class="buttons-container">
        <button 
          class="btn-auth" 
          (click)="verifyTotpSetup()"
          [disabled]="isVerifyingOtp">
          <i *ngIf="!isVerifyingOtp" class="bi bi-check-circle"></i>
          <span *ngIf="isVerifyingOtp" class="spinner-border spinner-border-sm"></span>
          <span>{{ isVerifyingOtp ? 'Verificando...' : 'Verificar y continuar' }}</span>
        </button>
        
        <button 
          class="btn-cancel" 
          (click)="cancelAndGoBack()"
          [disabled]="isVerifyingOtp">
          <i class="bi bi-x-circle"></i>
          <span>Cancelar</span>
        </button>
      </div>
    </div>

    <div *ngIf="errorMessage" class="error-message">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ errorMessage }}
    </div>

    <div *ngIf="successMessage" class="success-message">
        <i class="bi bi-check-circle me-2"></i>{{ successMessage }}
    </div>
  </form>
</div>