<html> 
  <body>   
    <div class="wrapper">
      <form class="login">
        <p class="title">
          <i class="bi bi-key-fill"></i>
          {{ showOtpVerification ? 'Verificación de código' : 'Inicio de sesión' }}
        </p>

        <!-- Campos normales de login (ocultos durante verificación OTP) -->
        <div *ngIf="!showOtpVerification">
          <div class="input-group">
            <i class="bi bi-person"></i>
            <input 
              type="email" 
              [(ngModel)]="username" 
              name="username" 
              placeholder="Email" 
              autocomplete="username webauthn"
              id="username"
              class="email-input"
              (focus)="onUsernameFieldFocus()"
              (click)="onUsernameFieldFocus()"/>
          </div>
          
          <!-- Campo de contraseña para login (solo visible si se activa) -->
          <div class="input-group" *ngIf="showLoginPasswordField">
            <i class="bi bi-lock"></i>
            <input 
              type="password" 
              [(ngModel)]="password" 
              name="password" 
              placeholder="Password" />
          </div>

          <div class="buttons-container">
            <!-- Botón para login adaptativo -->
            <button 
              class="btn-auth" 
              (click)="loginConContra()"
              [disabled]="isAuthenticating || isCheckingPasskeys">
              <i *ngIf="!isAuthenticating && !isCheckingPasskeys" class="bi" 
                [ngClass]="showLoginPasswordField ? 'bi-person-lock' : 'bi-arrow-right-circle'"></i>
              <span *ngIf="isAuthenticating || isCheckingPasskeys" class="spinner-border spinner-border-sm"></span>
              <span>{{ 
                isAuthenticating ? 'Autenticando...' : 
                isCheckingPasskeys ? 'Verificando...' :
                showLoginPasswordField ? 'Iniciar sesión' : 'Siguiente' 
              }}</span>
            </button>
          </div>

          <!-- Botón para passkey directo -->
          <button 
            class="btn-direct-auth" 
            (click)="directAuthentication()"
            [disabled]="isAuthenticating || isCheckingPasskeys">
            <span *ngIf="isAuthenticating_direct" class="spinner-border spinner-border-sm"></span>
            <i *ngIf="!isAuthenticating" class="bi bi-key"></i>
            <span>{{ isAuthenticating ? 'Autenticando...' : 'Usar una llave de acceso' }}</span>
          </button>
          
          <div class="links-container">
            <a (click)="goToRegister()">
              ¿NO TIENES CUENTA? REGISTRATE
            </a>
            <hr>
            <a (click)="goToRecovery()">RECUPERA TU CUENTA</a>
          </div>
        </div>

        <!-- Pantalla de verificación OTP -->
        <div *ngIf="showOtpVerification">
          <div class="input-group">
            <i class="bi bi-shield-lock"></i>
            <input 
              type="text" 
              [(ngModel)]="otpCode" 
              name="otpCode" 
              placeholder="Código de verificación" 
              maxlength="6"
              autocomplete="one-time-code" />
          </div>

          <div class="otp-description">
            <p>Introduce el código de verificación de 6 dígitos.</p>
            <p>Este código cambia cada 30 segundos. <span *ngIf="expirySeconds">Siguiente código en: {{ expirySeconds }}s</span></p>
            
            <!-- Demo token always displayed for convenience during development -->
            <div class="demo-token-container">
              <p *ngIf="demoOtpCode"><small>Código actual: <span class="demo-token">{{demoOtpCode}}</span></small></p>
            </div>
          </div>

          <div class="buttons-container">
            <button 
              class="btn-verify" 
              (click)="verifyAccount()"
              [disabled]="isVerifyingOtp">
              <i *ngIf="!isVerifyingOtp" class="bi bi-check-circle"></i>
              <span *ngIf="isVerifyingOtp" class="spinner-border spinner-border-sm"></span>
              <span>{{ isVerifyingOtp ? 'Verificando...' : 'Verificar' }}</span>
            </button>
            
            <button 
              class="btn-cancel" 
              (click)="cancelOtpVerification()"
              [disabled]="isVerifyingOtp">
              <i class="bi bi-x-circle"></i>
              <span>Cancelar</span>
            </button>
          </div>
        </div>
        
        <div *ngIf="errorMessage" class="error-message" [class.success]="errorMessage.includes('exitoso')">
          <i class="bi" [ngClass]="errorMessage.includes('exitoso') ? 'bi-check-circle' : 'bi-exclamation-triangle'"></i>
          {{ errorMessage }}
        </div>
      </form>
    </div>
  </body>
</html>