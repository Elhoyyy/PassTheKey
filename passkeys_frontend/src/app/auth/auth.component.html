<html> 
  <body>   
    <div class="wrapper" >
      <form class="login">
        <p class="title">
          <i class="bi bi-key-fill"></i>
          {{ isInRegistrationMode ? 'Registro de Usuario' : showOtpVerification ? 'Verificación de código' : 'Passkeys Login' }}
        </p>

        <!-- Campos normales de login/registro (ocultos durante verificación OTP) -->
        <div *ngIf="!showOtpVerification">
          <div class="input-group">
            <i class="bi bi-person"></i>
            <input 
              type="email" 
              [(ngModel)]="username" 
              name="username" 
              placeholder="Email" 
              autocomplete="username webauthn"
              id="username"
              (focus)="onUsernameFieldFocus()"
              (click)="onUsernameFieldFocus()"/>
          </div>

          <!-- Campo de contraseña para registro (solo visible si se activa) -->
          <div class="input-group" *ngIf="isInRegistrationMode && showPasswordForRegistration">
            <i class="bi bi-lock"></i>
            <input 
              type="password" 
              [(ngModel)]="password" 
              name="password" 
              placeholder="Password" />
          </div>
          
          <!-- Toggle para mostrar/ocultar contraseña en registro -->
          <div class="password-toggle" *ngIf="isInRegistrationMode">
            <label class="toggle">
              <input type="checkbox" [(ngModel)]="showPasswordForRegistration" name="showPassword" >
              <span class="slider"></span>
            </label>
            <span>Usar passkey</span>
          </div>
          
          <!-- Campo de contraseña para login (solo visible si se activa) -->
          <div class="input-group" *ngIf="!isInRegistrationMode && showLoginPasswordField">
            <i class="bi bi-lock"></i>
            <input 
              type="password" 
              [(ngModel)]="password" 
              name="password" 
              placeholder="Password" />
          </div>

          <div class="buttons-container">
            <!-- Si estamos en modo registro - Botón unificado para registro -->
            <button 
              *ngIf="isInRegistrationMode"
              class="btn-register" 
              (click)="handleRegistration()"
              [disabled]="isRegistering">
              <i *ngIf="!isRegistering" class="bi" [ngClass]="showPasswordForRegistration ? 'bi-person-plus' : 'bi-key'"></i>
              <span *ngIf="isRegistering" class="spinner-border spinner-border-sm"></span>
              <span>{{ isRegistering ? 'Registrando...' : showPasswordForRegistration ? 'Registrar con contraseña' : 'Registrar con passkey' }}</span>
            </button>
             
            <!-- Si NO estamos en modo registro - Botón para login adaptativo -->
            <button 
              *ngIf="!isInRegistrationMode"
              class="btn-auth" 
              (click)="loginConContra()"
              [disabled]="isAuthenticating || isCheckingPasskeys">
              <i *ngIf="!isAuthenticating && !isCheckingPasskeys" class="bi" 
                [ngClass]="showLoginPasswordField ? 'bi-person-lock' : 'bi-arrow-right-circle'"></i>
              <span *ngIf="isAuthenticating || isCheckingPasskeys" class="spinner-border spinner-border-sm"></span>
              <span>{{ 
                isAuthenticating ? 'Autenticando...' : 
                isCheckingPasskeys ? 'Verificando...' :
                showLoginPasswordField ? 'Iniciar sesión' : 'Siguiente' 
              }}</span>
            </button>
          </div>

          <!-- Si NO estamos en modo registro - Botón para passkey directo -->
          <button 
            *ngIf="!isInRegistrationMode"
            class="btn-direct-auth" 
            (click)="directAuthentication()"
            [disabled]="isAuthenticating || isCheckingPasskeys">
            <i *ngIf="!isAuthenticating" class="bi bi-key"></i>
            <span *ngIf="isAuthenticating" class="spinner-border spinner-border-sm"></span>
            <span>{{ isAuthenticating ? 'Autenticando...' : 'Usar cualquier passkey' }}</span>
          </button>
          
          <div class="links-container">
            <a (click)="toggleRegistrationMode()">
              {{ isInRegistrationMode ? 'Ya dispones de una cuenta? Logueate' : 'No tienes cuenta? REGISTRATE' }}
            </a>
            <hr>
            <a *ngIf="!isInRegistrationMode" >Perdiste la cuenta? Recupérala</a>
          </div>
        </div>

        <!-- Pantalla de verificación OTP -->
        <div *ngIf="showOtpVerification">
          <div class="input-group">
            <i class="bi bi-shield-lock"></i>
            <input 
              type="text" 
              [(ngModel)]="otpCode" 
              name="otpCode" 
              placeholder="Código de verificación" 
              maxlength="6"
              autocomplete="one-time-code" />
          </div>

          <div class="otp-description">
            <p>Se ha enviado un código de verificación a tu correo/dispositivo.</p>
            <p>Por favor, ingrésalo para continuar.</p>
            <p><small>Código de prueba: 123456</small></p>
          </div>

          <div class="buttons-container">
            <button 
              class="btn-verify" 
              (click)="verifyAccount()"
              [disabled]="isVerifyingOtp">
              <i *ngIf="!isVerifyingOtp" class="bi bi-check-circle"></i>
              <span *ngIf="isVerifyingOtp" class="spinner-border spinner-border-sm"></span>
              <span>{{ isVerifyingOtp ? 'Verificando...' : 'Verificar' }}</span>
            </button>
            
            <button 
              class="btn-cancel" 
              (click)="cancelOtpVerification()"
              [disabled]="isVerifyingOtp">
              <i class="bi bi-x-circle"></i>
              <span>Cancelar</span>
            </button>
          </div>
        </div>
        
        <div *ngIf="errorMessage" class="error-message" [class.success]="errorMessage.includes('exitoso')">
          <i class="bi" [ngClass]="errorMessage.includes('exitoso') ? 'bi-check-circle' : 'bi-exclamation-triangle'"></i>
          {{ errorMessage }}
        </div>
      </form>
    </div>
  </body>
</html>