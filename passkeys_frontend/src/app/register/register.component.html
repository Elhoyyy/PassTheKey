<body>
    <div class="wrapper">
    <form class="login">
        <p class="title">
        <i class="bi bi-key-fill"></i>
        {{ showOtpVerification ? 'Verificación de código' : 'Registro de Usuario' }}
        </p>

        <!-- Campos para registro (ocultos durante verificación OTP) -->
        <div *ngIf="!showOtpVerification && !showPasskeyNameDialog">
        <div class="input-group">
            <i class="bi bi-person"></i>
            <input 
            type="email" 
            [(ngModel)]="username" 
            name="username" 
            placeholder="Email" 
            autocomplete="username webauthn"
            id="username"
            class="email-input"/>
        </div>

        <!-- Campo de contraseña para registro (solo visible si se activa) -->
        <div class="input-group" *ngIf="showPasswordForRegistration">
            <i class="bi bi-lock"></i>
            <input 
            class ="password-input"
            type="password" 
            [(ngModel)]="password" 
            name="password" 
            placeholder="Password" />
        </div>
        
        <!-- Toggle para mostrar/ocultar contraseña en registro -->
        <div class="password-toggle">
            <label class="toggle">
            <input type="checkbox" [(ngModel)]="showPasswordForRegistration" name="showPassword">
            <span class="slider"></span>
            </label>
            <span>Usar passkey</span>
        </div>

        <div class="buttons-container">
            <!-- Botón unificado para registro -->
            <button 
            class="btn-register" 
            (click)="handleRegistration()"
            [disabled]="isRegistering">
            <i *ngIf="!isRegistering" class="bi" [ngClass]="showPasswordForRegistration ? 'bi-person-plus' : 'bi-key'"></i>
            <span *ngIf="isRegistering" class="spinner-border spinner-border-sm"></span>
            <span>{{ isRegistering ? 'Registrando...' : showPasswordForRegistration ? 'Registrar con contraseña' : 'Registrar con passkey' }}</span>
            </button>
        </div>
        
        <div class="links-container">
            <a (click)="goToLogin()">
            ¿DISPONES DE UNA CUENTA? LOGUEATE
            </a>
        </div>
        </div>

        <!-- Pantalla de verificación OTP -->
        <div *ngIf="showOtpVerification && !showPasskeyNameDialog">
          <div class="input-group">
            <i class="bi bi-shield-lock"></i>
            <input 
              type="text" 
              [(ngModel)]="otpCode" 
              name="otpCode" 
              placeholder="Código de verificación" 
              maxlength="6"
              autocomplete="one-time-code" />
          </div>

          <div class="otp-description">
            <p>Introduce el código de verificación de 6 dígitos.</p>
            <p>Este código cambia cada 30 segundos. <span *ngIf="expirySeconds">Siguiente código en: {{ expirySeconds }}s</span></p>
            <!-- QR code section -->
            <div *ngIf="showQrSetup" class="qr-setup">
              <h4>Configurar Autenticador</h4>
              <p>Escanea este código QR con tu aplicación de autenticación:</p>
              <img *ngIf="qrCodeUrl" [src]="qrCodeUrl" alt="QR Code" class="qr-code">
              
              <div class="manual-setup">
                <p>O ingresa manualmente este código:</p>
                <div class="secret-code">{{ otpSecret }}</div>
              </div>
              
              <div class="setup-warning">
                <p class="warning"><i class="bi bi-exclamation-triangle"></i> IMPORTANTE: Esta información solo se mostrará una vez.</p>
              </div>
              
              <button class="btn-secondary mt-2" (click)="confirmAuthenticatorSetup()">
                <i class="bi bi-check-circle"></i> Listo
              </button>
            </div>
            <!-- Show demo code and setup option -->
            <div *ngIf="!showQrSetup" class="demo-token-container">
              <p *ngIf="demoOtpCode"><small>Código actual: <span class="demo-token">{{demoOtpCode}}</span></small></p>
              <button *ngIf="!showQrSetup && !authenticatorConfigured" class="btn-link small" (click)="setupAuthenticator()">
                <i class="bi bi-qr-code"></i> Configurar aplicación de autenticación
              </button>
            </div>
          </div>

          <div class="buttons-container">
            <button 
              class="btn-verify" 
              (click)="verifyAccount()"
              [disabled]="isVerifyingOtp">
              <i *ngIf="!isVerifyingOtp" class="bi bi-check-circle"></i>
              <span *ngIf="isVerifyingOtp" class="spinner-border spinner-border-sm"></span>
              <span>{{ isVerifyingOtp ? 'Verificando...' : 'Verificar' }}</span>
            </button>
            
            <button 
              class="btn-cancel" 
              (click)="cancelOtpVerification()"
              [disabled]="isVerifyingOtp">
              <i class="bi bi-x-circle"></i>
              <span>Cancelar</span>
            </button>
          </div>
        </div>
        
        <!-- Improved Passkey naming dialog -->
        <div *ngIf="showPasskeyNameDialog" class="passkey-name-dialog">
          <div class="dialog-content">
            <div class="dialog-header">
              <h5><i class="bi bi-shield-lock"></i>Name Your Passkey</h5>
            </div>
            <div class="dialog-body">
              <p>A passkey helps you sign in quickly and securely without using a password.</p>
              <div class="input-group">
                <input type="text" class="form-control" [(ngModel)]="passkeyName" name="passkeyName" placeholder="Enter a name for this passkey">
              </div>

            </div>
            <div class="dialog-footer">
              <button class="btn btn-secondary" (click)="cancelPasskeyName()">
                <i class="bi bi-x-circle"></i>Cancel
              </button>
              <button class="btn btn-primary" (click)="confirmPasskeyName()" [disabled]="!passkeyName.trim()">
                <i class="bi bi-check-circle"></i>Continue
              </button>
            </div>
          </div>
        </div>
        
        <div *ngIf="errorMessage" class="error-message" >
        <i class="bi bi-exclamation-triangle"></i>
        {{ errorMessage }}
        </div>
        <div *ngIf="successMessage" class="success-message">
          <i class="bi bi-check-circle"></i>
          {{ successMessage }}
          </div>
    </form>
    </div>
</body>