<body>
    <div class="wrapper">
    <form class="login">
        <p class="title">
        <i class="bi bi-key-fill"></i>
        {{ showOtpVerification ? 'Habilitar 2FA' : 'Registro de Usuario' }}
        </p>

        <!-- Campos para registro (ocultos durante verificación OTP) -->
        <div *ngIf="!showOtpVerification && !showPasskeyNameDialog">
        <div class="input-group">
            <i class="bi bi-person"></i>
            <input 
          
            type="email" 
            [(ngModel)]="username" 
            name="username" 
            placeholder="Email" 
            autocomplete="username webauthn"
            id="username"
            class="email-input"/>
        </div>

        <!-- Campo de contraseña para registro (solo visible si se activa) -->
        <div class="input-group" *ngIf="showPasswordForRegistration">
            <i class="bi bi-lock"></i>
            <input 
            id="password"
            class ="password-input"
            type="password" 
            [(ngModel)]="password" 
            name="password" 
            placeholder="Password" 
            (input)="evaluatePasswordStrength()"/>
            <span class="password-tugle" (click)="togglePasswordVisibility('password')">
            <i class="bi bi-eye-slash"></i>
            </span>
        </div>

        <div class="password-requirements" *ngIf="showPasswordForRegistration">
          <p>La contraseña debe contener:</p>
          <ul>
            <li class="requirement" [ngClass]="{'met': passwordRequirements.length}">
              <i class="bi" [ngClass]="passwordRequirements.length ? 'bi-check-circle' : 'bi-x-circle'"></i>
              Mínimo 8 caracteres
            </li>
            <li class="requirement" [ngClass]="{'met': passwordRequirements.uppercase}">
              <i class="bi" [ngClass]="passwordRequirements.uppercase ? 'bi-check-circle' : 'bi-x-circle'"></i>
              Letra mayúscula
            </li>
            <li class="requirement" [ngClass]="{'met': passwordRequirements.number}">
              <i class="bi" [ngClass]="passwordRequirements.number ? 'bi-check-circle' : 'bi-x-circle'"></i>
              Número
            </li>
            <li class="requirement" [ngClass]="{'met': passwordRequirements.special}">
              <i class="bi" [ngClass]="passwordRequirements.special ? 'bi-check-circle' : 'bi-x-circle'"></i>
              Caracter Especial
            </li>
          </ul>
        </div>

        <!-- Toggle para mostrar/ocultar contraseña en registro -->
        <div class="password-toggle">
            <label class="toggle">
            <input type="checkbox" [(ngModel)]="showPasswordForRegistration" name="showPassword">
            <span class="slider"></span>
            </label>
            <span>Usar llaves de acceso</span>
        </div>

        <div class="buttons-container">
            <!-- Botón unificado para registro -->
            <button 
            class="btn-register" 
            (click)="handleRegistration()"
            [disabled]="isRegistering">
            <i *ngIf="!isRegistering" class="bi" [ngClass]="showPasswordForRegistration ? 'bi-person-plus' : 'bi-key'"></i>
            <span *ngIf="isRegistering" class="spinner-border spinner-border-sm"></span>
            <span>{{ isRegistering ? 'Registrando...' : showPasswordForRegistration ? 'Registrar con contraseña' : 'Registrar llave de acceso' }}</span>
            </button>
        </div>
        
        <div class="links-container">
            <a (click)="goToLogin()">
            ¿DISPONES DE UNA CUENTA? LOGUEATE
            </a>
        </div>
        </div>

        <!-- Pantalla de verificación OTP -->
        <div *ngIf="showOtpVerification && !showPasskeyNameDialog">


          <div class="otp-description">
            <p>Introduce el código de verificación de 6 dígitos. <span *ngIf="expirySeconds">Siguiente código en: {{ expirySeconds }}s</span></p>
            <!-- QR code section -->
            <div  class="qr-setup">
              <h4>Configurar Autenticador</h4>
              <p>Escanea este código QR con tu aplicación de autenticación:</p>
              <img *ngIf="qrCodeUrl" [src]="qrCodeUrl" alt="QR Code" class="qr-code">
              
              <div class="manual-setup">
                <p>O ingresa manualmente este código:</p>
                <div class="secret-code">{{ otpSecret }}</div>
              </div>
              
              <div class="setup-warning">
                <p class="warning"><i class="bi bi-exclamation-triangle"></i> IMPORTANTE: Esta información solo se mostrará una vez.</p>
              </div>
            </div>
            <!-- Show demo code and setup option -->
            <div  class="demo-token-container">
              <p *ngIf="demoOtpCode"><small>Código actual: <span class="demo-token">{{demoOtpCode}}</span></small></p>
            </div>
          </div>
          <div class="input-group">
            <i class="bi bi-shield-lock"></i>
            <input 
              type="text" 
              [(ngModel)]="otpCode" 
              name="otpCode" 
              placeholder="Código de verificación" 
              maxlength="6"
              autocomplete="one-time-code" />
          </div>
          <div class="dialog-footer">
            <button 
            class="btn btn-secondary" 
            (click)="cancelOtpVerification()"
            [disabled]="isVerifyingOtp">
            <i class="bi bi-x-circle"></i>
            <span>Cancelar</span>
          </button>
            <button 
              class="btn btn-primary" 
              (click)="verifyAccount()"
              [disabled]="isVerifyingOtp">
              <i *ngIf="!isVerifyingOtp" class="bi bi-check-circle"></i>
              <span *ngIf="isVerifyingOtp" class="spinner-border spinner-border-sm"></span>
              <span>{{ isVerifyingOtp ? 'Verificando...' : 'Verificar' }}</span>
            </button>
            
          </div>
        </div>
        
        <!-- Improved Passkey naming dialog -->
        <div *ngIf="showPasskeyNameDialog" class="passkey-name-dialog">
          <div class="dialog-content">
            <div class="dialog-header">
              <h5><i class="bi bi-shield-lock"></i>Nombra tu Llave de Acceso</h5>
            </div>
            <div class="dialog-body">
              <p>La llave de acceso te ayuda a iniciar sesión de forma rápida y segura sin contraseñas.</p>
              <div class="input-group">
                <input type="text" class="form-control" [(ngModel)]="passkeyName" name="passkeyName" placeholder="Enter a name for this passkey">
              </div>

            </div>
            <div class="dialog-footer">
              <button class="btn btn-secondary" (click)="cancelPasskeyName()">
                <i class="bi bi-x-circle"></i>Cancelar
              </button>
              <button class="btn btn-primary" (click)="confirmPasskeyName()" [disabled]="!passkeyName.trim()">
                <i class="bi bi-check-circle"></i>Continuar
              </button>
            </div>
          </div>
        </div>
        
        <!-- 2FA Confirmation dialog -->
        <div *ngIf="show2FAConfirmationDialog" class="passkey-name-dialog">
          <div class="dialog-content">
            <div class="dialog-header">
              <h5><i class="bi bi-shield-lock"></i>Configuración de Segundo Factor</h5>
            </div>
            <div class="dialog-body">
              <p><strong>Autenticación de Dos Factores Requerida</strong></p>
              <p>Para aumentar la seguridad de tu cuenta, se configurará un segundo factor de autenticación (2FA) tras el registro.</p>
              <div class="info-message">
                <i class="bi bi-info-circle"></i>
                <p>Necesitarás una aplicación como:</p>
                <ul>
                  <li>Google Authenticator</li>
                  <li>Microsoft Authenticator</li>
                  <li>Authy</li>
                  <li>1Password</li>
                </ul>
                <p>Esta aplicación generará códigos de verificación cada 30 segundos que deberás usar cada vez que inicies sesión.</p>
              </div>
            </div>
            <div class="dialog-footer">
              <button class="btn btn-primary" (click)="confirm2FASetup()">
                <i class="bi bi-check-circle"></i>Entendido
              </button>
            </div>
          </div>
        </div>
        
        <div *ngIf="errorMessage" class="error-message" >
        <i class="bi bi-exclamation-triangle"></i>
        {{ errorMessage }}
        </div>
        <div *ngIf="successMessage" class="success-message">
          <i class="bi bi-check-circle"></i>
          {{ successMessage }}
          </div>
    </form>
    </div>
</body>