<body>
    <div class="wrapper">
    <form class="login">
        <p class="title">
        <i class="bi bi-key-fill"></i>
        {{ showOtpVerification ? 'Verificación de código' : 'Registro de Usuario' }}
        </p>

        <!-- Campos para registro (ocultos durante verificación OTP) -->
        <div *ngIf="!showOtpVerification && !showPasskeyNameDialog">
        <div class="input-group">
            <i class="bi bi-person"></i>
            <input 
            type="email" 
            [(ngModel)]="username" 
            name="username" 
            placeholder="Email" 
            autocomplete="username webauthn"
            id="username"
            class="email-input"/>
        </div>

        <!-- Campo de contraseña para registro (solo visible si se activa) -->
        <div class="input-group" *ngIf="showPasswordForRegistration">
            <i class="bi bi-lock"></i>
            <input 
            type="password" 
            [(ngModel)]="password" 
            name="password" 
            placeholder="Password" />
        </div>
        
        <!-- Toggle para mostrar/ocultar contraseña en registro -->
        <div class="password-toggle">
            <label class="toggle">
            <input type="checkbox" [(ngModel)]="showPasswordForRegistration" name="showPassword">
            <span class="slider"></span>
            </label>
            <span>Usar passkey</span>
        </div>

        <div class="buttons-container">
            <!-- Botón unificado para registro -->
            <button 
            class="btn-register" 
            (click)="handleRegistration()"
            [disabled]="isRegistering">
            <i *ngIf="!isRegistering" class="bi" [ngClass]="showPasswordForRegistration ? 'bi-person-plus' : 'bi-key'"></i>
            <span *ngIf="isRegistering" class="spinner-border spinner-border-sm"></span>
            <span>{{ isRegistering ? 'Registrando...' : showPasswordForRegistration ? 'Registrar con contraseña' : 'Registrar con passkey' }}</span>
            </button>
        </div>
        
        <div class="links-container">
            <a (click)="goToLogin()">
            Ya dispones de una cuenta? Logueate
            </a>
        </div>
        </div>

        <!-- Pantalla de verificación OTP -->
        <div *ngIf="showOtpVerification && !showPasskeyNameDialog">
        <div class="input-group">
            <i class="bi bi-shield-lock"></i>
            <input 
            type="text" 
            [(ngModel)]="otpCode" 
            name="otpCode" 
            placeholder="Código de verificación" 
            maxlength="6"
            autocomplete="one-time-code" />
        </div>

        <div class="otp-description">
            <p>Se ha enviado un código de verificación a tu correo/dispositivo.</p>
            <p>Por favor, ingrésalo para continuar.</p>
            <p><small>Código de prueba: 123456</small></p>
        </div>

        <div class="buttons-container">
            <button 
            class="btn-verify" 
            (click)="verifyAccount()"
            [disabled]="isVerifyingOtp">
            <i *ngIf="!isVerifyingOtp" class="bi bi-check-circle"></i>
            <span *ngIf="isVerifyingOtp" class="spinner-border spinner-border-sm"></span>
            <span>{{ isVerifyingOtp ? 'Verificando...' : 'Verificar' }}</span>
            </button>
            
            <button 
            class="btn-cancel" 
            (click)="cancelOtpVerification()"
            [disabled]="isVerifyingOtp">
            <i class="bi bi-x-circle"></i>
            <span>Cancelar</span>
            </button>
        </div>
        </div>
        
        <!-- Improved Passkey naming dialog -->
        <div *ngIf="showPasskeyNameDialog" class="passkey-name-dialog">
          <div class="dialog-content">
            <div class="dialog-header">
              <h5><i class="bi bi-shield-lock"></i>Name Your Passkey</h5>
            </div>
            <div class="dialog-body">
              <p>A passkey helps you sign in quickly and securely without using a password.</p>
              <div class="input-group">
                <input type="text" class="form-control" [(ngModel)]="passkeyName" name="passkeyName" placeholder="Enter a name for this passkey">
              </div>

            </div>
            <div class="dialog-footer">
              <button class="btn btn-secondary" (click)="cancelPasskeyName()">
                <i class="bi bi-x-circle"></i>Cancel
              </button>
              <button class="btn btn-primary" (click)="confirmPasskeyName()" [disabled]="!passkeyName.trim()">
                <i class="bi bi-check-circle"></i>Continue
              </button>
            </div>
          </div>
        </div>
        
        <div *ngIf="errorMessage" class="error-message" [class.success]="errorMessage.includes('exitoso')">
        <i class="bi" [ngClass]="errorMessage.includes('exitoso') ? 'bi-check-circle' : 'bi-exclamation-triangle'"></i>
        {{ errorMessage }}
        </div>
    </form>
    </div>
</body>