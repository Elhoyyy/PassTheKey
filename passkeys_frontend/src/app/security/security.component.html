<body>
<div class="wrapper">
    <div class="content">
      <div class="container-fluid mt-5">
        <div class="row d-flex justify-content-center">
          <div class="col-md-7">
            <!-- Modified the class here to match profile component -->
            <div class="card">
              <div class="text-center mb-4">
                <h3><i class="bi bi-shield-lock me-2"></i>Ajustes de Seguridad</h3>
                <p class="text-muted">Revisa los métodos de protección disponibles</p>
                
                <!-- Security Status Indicator -->
                <div class="security-score-container">
                  <div class="security-score-wrapper">
                    <div class="security-score" [ngStyle]="{'background': 'conic-gradient(' + getSecurityScoreColor() + ' 0% ' + securityScore + '%, #e9ecef ' + securityScore + '% 100%)'}">
                      <div class="security-score-value">{{ securityScore }}%</div>
                    </div>
                  </div>
                  <div class="security-score-label">
                    <p>La seguridad de tu cuenta:</p>
                    <span *ngIf="securityScore === 0">Extremadamente Vulnerable - Añade medidas de seguridad</span>
                    <span *ngIf="securityScore === 25">Bastante Flojo - Añade una llave de acceso para mayor seguridad</span>
                    <span *ngIf="securityScore === 50">Basico - Añade una contraseña segura</span>
                    <span *ngIf="securityScore === 75">Bien, pero podrías añadir otra llave de acceso</span>
                    <span *ngIf="securityScore === 100">Muy Seguro!</span>
                  </div>
                </div>
              </div>
              
              <!-- Passkeys Management Section -->
              <div class="section mt-4">
                <div class="section-header">
                  <i class="bi bi-fingerprint"></i>
                  <h5 class="section-title">Administración de llaves de acceso </h5>
                  <!-- Add info icon -->
                  <i class="bi bi-info-circle info-icon" (click)="showPasskeyInfoModal()"></i>
                </div>
                
                <!-- Passkey recommendation message -->
                <div *ngIf="showPasskeyRecommendation" class="alert alert-info mt-2 passkey-recommendation">
                  <div class="recommendation-header">
                    <i class="bi bi-shield-lock"></i>
                    <strong>Mejora tu seguridad</strong>
                  </div>
                  <p>Actualmente no dispones de ninguna Llave de Acceso.</p>
                  <p>Añadir una  mejorará notablemente la seguridad.</p>
                  <button class="btn btn-primary mt-3 centered-btn" (click)="startPasskeyRegistration()" [disabled]="isLoading">
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    {{ isLoading ? ' Añadiendo...' : 'Añade Una!' }}
                  </button>
                </div>
                
                <!-- Recovery passkey recommendation message - only show when exactly 1 passkey exists -->
                <div *ngIf="devices.length === 1 && !hasPassword" class="alert alert-warning mt-2 recovery-recommendation">
                  <div class="recommendation-header">
                    <i class="bi bi-key"></i>
                    <strong>Asegura el acceso a tu cuenta</strong>
                  </div>
                  <p>Te recomendamos registrar una segunda en otro dispositivo.</p>
                  <p>Así podrás recuperar tu cuenta incluso si pierdes tu dispositivo actual.</p>
                  <button class="btn btn-secondary mt-3 centered-btn" (click)="startPasskeyRegistration()" [disabled]="isLoading">
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    {{ isLoading ? ' Añadiendo...' : 'Añadir llave de backup' }}
                  </button>
                </div>
                
                <div class="passkey-info mt-4" *ngIf="devices.length > 0">
                  <div class="passkey-info-header">
                    <i class="bi bi-shield-lock"></i>
                    <h3>Llaves de Acceso Registradas:</h3>
                  </div>
                <div class="device-list-container">
                  <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center" 
                        *ngFor="let device of devices; let i = index"
                        [ngClass]="{'last-used-device': i === lastUsedDeviceIndex}">
                      <div class="device-info">
                        <div class="device-icon" [ngClass]="{'last-used-icon': i === lastUsedDeviceIndex}">
                          <i class="bi bi-laptop"></i>
                        </div>
                        <!-- Show input field when editing this device -->
                        <div class="device-details">
                          <span class="device-name" *ngIf="editingDeviceIndex !== i">
                            {{ device.name }}
                            <span class="last-used-badge" *ngIf="i === lastUsedDeviceIndex">Dispositivo actual </span>
                          </span>
                          <div *ngIf="editingDeviceIndex === i" class="edit-name-form">
                            <input type="text" class="form-control device-edit-input" [(ngModel)]="newDeviceName">
                            <div class="edit-buttons mt-2">
                              <button class="btn btn-primary me-2" (click)="updateDeviceName(i, newDeviceName)" [disabled]="isLoadingName">
                                <span *ngIf="isLoadingName" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Guardar
                              </button>
                              <button class="btn btn-secondary" (click)="cancelEditingDevice()">Cancelar</button>
                            </div>
                          </div>
                          <div class="device-dates">
                            <small class="text-muted">Creado: {{ device.creationDate }}</small>
                            <small class="text-muted">Último uso: {{ device.lastUsed | date:'dd/MM/yyyy HH:mm' }}</small>
                            <small class="text-muted device-agent" *ngIf="device.userAgent">Dispositivo: {{ formatUserAgent(device.userAgent) }}</small>
                          </div>
                        </div>
                      </div>
                      <div class="device-actions">
                        <!-- Edit button - only show when not currently editing this device -->
                        <button class="btn btn-sm btn-outline-primary me-2" *ngIf="editingDeviceIndex !== i" (click)="startEditingDevice(i)">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <!-- Delete button - only show when not editing -->
                        <button class="btn btn-sm btn-danger" *ngIf="editingDeviceIndex !== i" (click)="deleteDevice(i)">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </li>
                  </ul>
                </div>
                </div>
                <!-- Improved Passkey naming dialog -->
                <div *ngIf="showPasskeyNameDialog" class="passkey-name-dialog">
                  <div class="dialog-content">
                    <div class="dialog-header">
                      <h5><i class="bi bi-shield-lock"></i>Nombre tu Llave de Acceso:</h5>
                    </div>
                    <div class="dialog-body">
                      <p>La llave de acceso te ayuda a iniciar sesión de forma rápida y segura sin contraseñas.</p>
                      <div class="input-group">
                        <input type="text" class="form-control" [(ngModel)]="newPasskeyName" placeholder="Enter a name for this passkey">
                      </div>
                    </div>
                    <div class="dialog-footer">
                      <button class="btn btn-secondary" (click)="cancelPasskeyName()">
                        <i class="bi bi-x-circle"></i>Cancelar
                      </button>
                      <button class="btn btn-primary" (click)="confirmPasskeyName()" [disabled]="!newPasskeyName.trim()">
                        <i class="bi bi-check-circle"></i>Continuar
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="passkey-action">
                  <button class="btn btn-outline-primary px-4 add-passkey-btn" *ngIf="(showAddDeviceButton && hasPassword && devices.length >= 1) || (showAddDeviceButton && !hasPassword && devices.length > 1)" (click)="startPasskeyRegistration()" [disabled]="isLoading">
                    <i *ngIf="!isLoading" class="bi bi-plus-circle"></i>
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    {{ isLoading ? 'Añadiendo...' : 'Añade más Llaves De Acceso' }}
                  </button>
                  <div *ngIf="errorMessage" class="alert alert-danger mt-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMessage }}
                  </div>
                  <div *ngIf="successMessage" class="alert alert-success mt-3">
                    <i class="bi bi-check-circle me-2"></i>{{ successMessage }}
                  </div>
                </div>
              </div> 
              <!-- Password Change Section -->
              <div class="section">
                <div class="section-header">
                  <i class="bi bi-key-fill"></i>
                  <h5 class="section-title">
                    {{ hasPassword ? 'Cambiar contraseña' : 'Añadir Contraseña y 2FA' }}
                  </h5>
                  <i class="bi bi-info-circle info-icon" *ngIf="!hasPassword" (click)="show2FAConfirmation()"></i>
                </div>
                
                <!-- 2FA Status Badge -->
                <div class="twofa-status">
                  <span class="twofa-badge" [ngClass]="{'enabled': has2FA, 'disabled': !has2FA}">
                    <i class="bi" [ngClass]="has2FA ? 'bi-shield-check' : 'bi-shield'"></i>
                    2FA {{ has2FA ? 'Activado' : 'No Activado' }}
                  </span>
                  <small *ngIf="!has2FA" class="text-muted">Al añadir contraseña se procederá a la configuración de un 2FA</small>
                </div>
                
                <!-- Password form - always visible now, no more *ngIf="!showOtpVerification -->
                <div class="password-section">
                  <div class="password-strength-meter">
                    <p>Seguridad de la contraseña:</p>
                    <div class="strength-bar">
                      <div class="strength-level" [ngClass]="passwordStrength">
                      </div>
                    </div>
                    <span class="strength-text" [ngClass]="passwordStrength">{{ passwordStrength | titlecase }}</span>
                    <p class="last-updated">
                      <ng-container *ngIf="passwordCreationDate !== 'Not changed yet'">
                        Último cambio: {{ passwordCreationDate }}
                      </ng-container>
                      <ng-container *ngIf="passwordCreationDate === 'Not changed yet'">
                        Sin contraseña configurada
                      </ng-container>
                    </p>
                  </div>
                  
                  <!-- Current password field - only show when changing existing password -->
                  <div class="form-group" *ngIf="hasPassword">
                    <div class="password-field">
                      <input type="password" id="currentPassword" class="form-control" 
                        placeholder="Contraseña Actual" 
                        [(ngModel)]="currentPassword">
                      <span class="password-toggle" (click)="togglePasswordVisibility('currentPassword')">
                        <i class="bi bi-eye-slash"></i>
                      </span>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <div class="password-field">
                      <input type="password" id="newPassword" class="form-control" 
                        placeholder="{{ hasPassword ? 'Nueva Contraseña' : 'Contraseña' }}" 
                        [(ngModel)]="newPassword" 
                        (input)="evaluatePasswordStrength()">
                      <span class="password-toggle" (click)="togglePasswordVisibility('newPassword')">
                        <i class="bi bi-eye-slash"></i>
                      </span>
                    </div>
                    <div class="password-field mt-2">
                      <input type="password" id="confirmPassword" class="form-control" 
                        placeholder="Confirmar Contraseña" 
                        [(ngModel)]="confirmPassword">
                      <span class="password-toggle" (click)="togglePasswordVisibility('confirmPassword')">
                        <i class="bi bi-eye-slash"></i>
                      </span>
                    </div>
                    <div class="password-requirements">
                      <p>La contraseña debe contener:</p>
                      <ul>
                        <li class="requirement" [ngClass]="{'met': passwordRequirements.length}">
                          <i class="bi" [ngClass]="passwordRequirements.length ? 'bi-check-circle' : 'bi-x-circle'"></i>
                          Mínimo 8 caracteres
                        </li>
                        <li class="requirement" [ngClass]="{'met': passwordRequirements.uppercase}">
                          <i class="bi" [ngClass]="passwordRequirements.uppercase ? 'bi-check-circle' : 'bi-x-circle'"></i>
                          Letra mayúscula
                        </li>
                        <li class="requirement" [ngClass]="{'met': passwordRequirements.number}">
                          <i class="bi" [ngClass]="passwordRequirements.number ? 'bi-check-circle' : 'bi-x-circle'"></i>
                          Número
                        </li>
                        <li class="requirement" [ngClass]="{'met': passwordRequirements.special}">
                          <i class="bi" [ngClass]="passwordRequirements.special ? 'bi-check-circle' : 'bi-x-circle'"></i>
                          Caracter Especial
                        </li>
                      </ul>
                    </div>
                    <div class="text-center">
                      <button class="btn btn-primary mt-3 centered-btn" (click)="updatePassword()" [disabled]="isPasswordLoading">
                        <span *ngIf="isPasswordLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        {{ isPasswordLoading ? 'Actualizando...' : hasPassword ? 'Actualizar contraseña' : 'Añadir contraseña' }}
                      </button>
                    </div>
                  </div>
                  <div *ngIf="passwordError" class="alert alert-danger mt-2">
                    <i class="bi bi-exclamation-triangle me-2"></i>{{ passwordError }}
                  </div>
                  <div *ngIf="passwordSuccess" class="alert alert-success mt-2">
                    <i class="bi bi-check-circle me-2"></i>{{ passwordSuccess }}
                  </div>
                </div>
              </div>

              
              <!-- OTP verification dialog - now a modal overlay -->
              <div *ngIf="showOtpDialog" class="otp-dialog-overlay">
                <div class="otp-dialog">
                  <div class="dialog-header">
                    <h5><i class="bi bi-shield-lock me-2"></i>Configurar Autenticación en Dos Factores</h5>
                    <p class="text-muted">Necesario para añadir una contraseña</p>
                  </div>
                  
                  <div class="dialog-body">        
                    <div class="otp-description">
                      <p>Introduce el código de verificación de 6 dígitos. <span *ngIf="expirySeconds">Siguiente código en: {{ expirySeconds }}s</span></p>
                      
                      <!-- QR code section -->
                      <div class="qr-setup">
                        <h4>Configurar Autenticador</h4>
                        <p>Escanea este código QR con tu aplicación de autenticación:</p>
                        <img *ngIf="qrCodeUrl" [src]="qrCodeUrl" alt="QR Code" class="qr-code">
                        
                        <div class="manual-setup">
                          <p>O ingresa manualmente este código:</p>
                          <div class="secret-code">
                            {{ otpSecret }}
                            <button class="copy-button" (click)="copyToClipboard(otpSecret)" title="Copiar al portapapeles">
                              <i class="bi" [ngClass]="copied ? 'bi-clipboard-check' : 'bi-clipboard'"></i>
                            </button>
                          </div>
                        </div>
                        
                        <div class="setup-warning">
                          <p class="warning"><i class="bi bi-exclamation-triangle"></i> IMPORTANTE: Esta información solo se mostrará una vez.</p>
                        </div>
                      </div>
                      
                      <!-- Show demo code 
                      <div class="demo-token-container">
                        <p *ngIf="demoOtpCode"><small>Código actual: <span class="demo-token">{{demoOtpCode}}</span></small></p>
                      </div> -->
                      
                    </div>
                  </div>
                  <div class="input-group">
                    <i class="bi bi-shield-lock"></i>
                    <input 
                      type="text" 
                      [(ngModel)]="otpCode" 
                      name="otpCode" 
                      placeholder="Código de verificación" 
                      maxlength="6"
                      autocomplete="one-time-code" />
                  </div>
                  <div class="buttons-container">

                    <button 
                      class="btn-action btn-secondary" 
                      (click)="cancelOtp()"
                      [disabled]="isVerifyingOtp">
                      <i class="bi bi-x-circle"></i>
                      <span>Cancelar</span>
                    </button>
                    <button 
                      class="btn-action btn-primary" 
                      (click)="verifyOtp()"
                      [disabled]="isVerifyingOtp">
                      <i *ngIf="!isVerifyingOtp" class="bi bi-check-circle"></i>
                      <span *ngIf="isVerifyingOtp" class="spinner-border spinner-border-sm"></span>
                      <span>{{ isVerifyingOtp ? 'Verificando...' : 'Verificar' }}</span>
                    </button>
                  </div>
                  <div *ngIf="errorMessageModal" class="alert alert-danger mt-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMessageModal }}
                  </div>
                  <div *ngIf="successMessageModal" class="alert alert-success mt-3">
                    <i class="bi bi-check-circle me-2"></i>{{ successMessageModal }}
                  </div>
                </div>
              </div>
              
              <!-- Add the passkey info modal -->
              <div *ngIf="showPasskeyInfo" class="passkey-info-modal">
                <div class="modal-content">
                  <div class="modal-header">
                    <i class="bi bi-info-circle"></i>
                    <h5>Sobre Llaves de Acceso</h5>
                  </div>
                  <div class="modal-body">
                    <p>Estas ofrecen una seguridad mayor respecto a contraseñas tradicionales:</p>
                    <ul class="benefits-list">
                      <li><i class="bi bi-check2-circle"></i> No se pueden robar por phishing</li>
                      <li><i class="bi bi-check2-circle"></i> Únicas para cada Web</li>
                      <li><i class="bi bi-check2-circle"></i> Usan autenticación por biometría</li>
                      <li><i class="bi bi-check2-circle"></i> Simplifican el proceso de inicio de sesión.</li>
                    </ul>
                  </div>
                  <div class="dialog-footer">
                    <button class="btn btn-primary" (click)="hidePasskeyInfoModal()">Entendido</button>
                  </div>
                </div>
              </div>     
              <!-- 2FA Confirmation dialog -->
              <div *ngIf="show2FAConfirmationDialog" class="passkey-name-dialog">
                <div class="dialog-content">
                  <div class="dialog-header">
                    <h5><i class="bi bi-shield-lock"></i>Configuración de Segundo Factor</h5>
                  </div>
                  <div class="dialog-body">
                    <p><strong>Autenticación de Dos Factores Requerida</strong></p>
                    <p>Para aumentar la seguridad de tu cuenta, se configurará un segundo factor de autenticación (2FA) tras el registro.</p>
                    <div class="info-message">
                      <i class="bi bi-info-circle"></i>
                      <p>Necesitarás una aplicación como:</p>
                      <ul>
                        <li>Google Authenticator</li>
                        <li>Microsoft Authenticator</li>
                        <li>Authy</li>
                        <li>1Password</li>
                      </ul>
                      <p>Esta aplicación generará códigos de verificación cada 30 segundos que deberás usar cada vez que inicies sesión.</p>
                    </div>
                  </div>
                  <div class="dialog-footer">
                    <button class="btn btn-primary" (click)="confirm2FASetup()">
                      <i class="bi bi-check-circle"></i>Entendido
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Add the passkey deletion confirmation dialog -->
              <div *ngIf="showDeleteConfirmDialog" class="passkey-name-dialog">
                <div class="dialog-content">
                  <div class="dialog-header">
                    <h5><i class="bi bi-exclamation-triangle text-danger"></i> Confirmar Eliminación</h5>
                  </div>
                  <div class="dialog-body">
                    <p>¿Estás seguro que quieres eliminarla?</p>
                    <p class="text-muted">Esta acción no se puede deshacer.</p>
                  </div>
                  <div class="dialog-footer">
                    <button class="btn btn-secondary" (click)="cancelDeleteDevice()">
                      <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button class="btn btn-danger" (click)="confirmDeleteDevice()">
                      <i class="bi bi-check-circle"></i> Confirmar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>